# TODO: Clean up this directory and its dependencies
set_property(DIRECTORY PROPERTY LLDB_PLUGIN_KIND ProcessUtility)

# Conditionally find AMD-dbgapi package
set(amd-dbgapi_DIR "${ROCM_PATH}/lib/cmake/amd-dbgapi" CACHE PATH "Path to amd-dbgapi cmake config")
find_package(amd-dbgapi QUIET CONFIG)

# Set up source files list
set(PROCESS_UTILITY_SOURCES
  AuxVector.cpp
  FreeBSDSignals.cpp
  GDBRemoteSignals.cpp
  HistoryThread.cpp
  HistoryUnwind.cpp
  InferiorCallPOSIX.cpp
  LinuxProcMaps.cpp
  LinuxSignals.cpp
  MemoryTagManagerAArch64MTE.cpp
  NativeProcessSoftwareSingleStep.cpp
  NativeRegisterContextDBReg.cpp
  NativeRegisterContextDBReg_arm.cpp
  NativeRegisterContextDBReg_arm64.cpp
  NativeRegisterContextDBReg_loongarch.cpp
  NativeRegisterContextDBReg_x86.cpp
  NativeRegisterContextRegisterInfo.cpp
  NetBSDSignals.cpp
  OpenBSDSignals.cpp
  RegisterContext_x86.cpp
  RegisterContextDarwin_arm.cpp
  RegisterContextDarwin_arm64.cpp
  RegisterContextDarwin_riscv32.cpp
  RegisterContextDarwin_x86_64.cpp
  RegisterContextDummy.cpp
  RegisterContextFreeBSD_i386.cpp
  RegisterContextFreeBSD_mips64.cpp
  RegisterContextFreeBSD_powerpc.cpp
  RegisterContextFreeBSD_x86_64.cpp
  RegisterContextHistory.cpp
  RegisterContextLinux_i386.cpp
  RegisterContextLinux_x86_64.cpp
  RegisterContextLinux_s390x.cpp
  RegisterContextMach_arm.cpp
  RegisterContextMach_x86_64.cpp
  RegisterContextMemory.cpp
  RegisterContextNetBSD_i386.cpp
  RegisterContextNetBSD_x86_64.cpp
  RegisterContextOpenBSD_i386.cpp
  RegisterContextOpenBSD_x86_64.cpp
  RegisterContextPOSIX_arm.cpp
  RegisterContextPOSIX_arm64.cpp
  RegisterContextPOSIX_loongarch64.cpp
  RegisterContextPOSIX_mips64.cpp
  RegisterContextPOSIX_riscv32.cpp
  RegisterContextPOSIX_powerpc.cpp
  RegisterContextPOSIX_ppc64le.cpp
  RegisterContextPOSIX_riscv64.cpp
  RegisterContextPOSIX_s390x.cpp
  RegisterContextPOSIX_x86.cpp
  RegisterContextThreadMemory.cpp
  RegisterContextWindows_i386.cpp
  RegisterContextWindows_x86_64.cpp
  RegisterFlagsDetector_arm64.cpp
  RegisterInfos_x86_64_with_base_shared.cpp
  RegisterInfoPOSIX_arm.cpp
  RegisterInfoPOSIX_arm64.cpp
  RegisterInfoPOSIX_loongarch64.cpp
  RegisterInfoPOSIX_ppc64le.cpp
  RegisterInfoPOSIX_riscv32.cpp
  RegisterInfoPOSIX_riscv64.cpp
  StopInfoMachException.cpp
  ThreadMemory.cpp
)

# Conditionally add AMD GPU support if amd-dbgapi is found
set(LINK_LIBS_LIST
  lldbBreakpoint
  lldbCore
  lldbDataFormatters
  lldbExpression
  lldbHost
  lldbSymbol
  lldbTarget
  lldbUtility
  lldbValueObject
)

if(amd-dbgapi_FOUND)
  message(STATUS "AMD-dbgapi found, enabling AMDGPU support in ProcessUtility")
  list(APPEND PROCESS_UTILITY_SOURCES RegisterContextAmdGpuImpl.cpp)
  list(APPEND LINK_LIBS_LIST amd-dbgapi)
  include_directories(${ROCM_PATH}/include)
endif()

add_lldb_library(lldbPluginProcessUtility
  ${PROCESS_UTILITY_SOURCES}

  LINK_COMPONENTS
    Support
    TargetParser
  LINK_LIBS
    ${LINK_LIBS_LIST}
  )
